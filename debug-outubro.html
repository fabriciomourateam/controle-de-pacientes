<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Vendas Outubro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1e293b;
            color: #e2e8f0;
        }
        .card {
            background: #334155;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        h1 { color: #38bdf8; }
        h2 { color: #a78bfa; margin-top: 20px; }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin: 2px;
        }
        .comprou { background: #22c55e; color: #fff; }
        .nao-comprou { background: #ef4444; color: #fff; }
        .no-show { background: #f59e0b; color: #fff; }
        .neutral { background: #6b7280; color: #fff; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #475569;
        }
        th {
            background: #1e293b;
            font-weight: 600;
        }
        .metric {
            display: inline-block;
            margin: 10px;
            padding: 15px 25px;
            background: #1e293b;
            border-radius: 8px;
            text-align: center;
        }
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 14px;
            color: #94a3b8;
            text-transform: uppercase;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background: #2563eb;
        }
        .warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 15px 0;
            color: #92400e;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üîç Debug Vendas - Outubro</h1>
    
    <div class="card">
        <button onclick="analisarOutubro()">üîÑ Analisar Dados de Outubro</button>
        <button onclick="compararMeses()">üìä Comparar Todos os Meses</button>
    </div>

    <div id="resultados"></div>

    <script>
        const SUPABASE_URL = 'https://zxqnrhqjujqngljvzjto.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4cW5yaHFqdWpxbmdsanZ6anRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwMzI0NDcsImV4cCI6MjA2MDYwODQ0N30.BNLQ7sL_cEH3vz0dkv66VbkK6lx_Jg2PqVxMOLBYKBU';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function analisarOutubro() {
            const resultados = document.getElementById('resultados');
            resultados.innerHTML = '<p>Carregando dados...</p>';

            try {
                console.log('üîç Buscando todas as vendas...');
                const { data: vendas, error } = await supabase
                    .from('Total de Vendas')
                    .select('*')
                    .order('DATA', { ascending: false });

                if (error) throw error;

                console.log('‚úÖ Total de vendas:', vendas.length);

                // Filtrar apenas Outubro
                const vendasOutubro = vendas.filter(v => 
                    v.M√äS && v.M√äS.toLowerCase().includes('outubro')
                );

                console.log('üìä Vendas de Outubro:', vendasOutubro.length);

                // An√°lise detalhada
                let comprou = 0, naoComprou = 0, noShow = 0, semStatus = 0;
                const problemas = [];

                vendasOutubro.forEach((v, index) => {
                    const comprouVal = v.COMPROU;
                    const naoComprouVal = v['N√ÉO COMPROU'];
                    const noShowVal = v['NO SHOW'];

                    // Log de cada registro
                    console.log(`Registro ${index + 1}:`, {
                        data: v.DATA,
                        comprou: comprouVal,
                        naoComprou: naoComprouVal,
                        noShow: noShowVal,
                        funil: v.FUNIL,
                        closer: v['QUEM FEZ A CALL']
                    });

                    // Contar status
                    if (comprouVal === '1') comprou++;
                    if (naoComprouVal === '1') naoComprou++;
                    if (noShowVal === '1') noShow++;

                    // Verificar se tem m√∫ltiplos status ou nenhum
                    const statusCount = [
                        comprouVal === '1',
                        naoComprouVal === '1',
                        noShowVal === '1'
                    ].filter(Boolean).length;

                    if (statusCount === 0) {
                        semStatus++;
                        problemas.push({
                            tipo: 'Sem Status',
                            registro: v,
                            index: index + 1
                        });
                    } else if (statusCount > 1) {
                        problemas.push({
                            tipo: 'M√∫ltiplos Status',
                            registro: v,
                            index: index + 1
                        });
                    }
                });

                // An√°lise de valores √∫nicos
                const valoresUnicos = {
                    comprou: [...new Set(vendasOutubro.map(v => v.COMPROU))],
                    naoComprou: [...new Set(vendasOutubro.map(v => v['N√ÉO COMPROU']))],
                    noShow: [...new Set(vendasOutubro.map(v => v['NO SHOW']))]
                };

                // Montar HTML de resultado
                let html = `
                    <div class="card">
                        <h2>üìä Resumo - Outubro</h2>
                        <div>
                            <div class="metric" style="background: #16a34a;">
                                <div class="metric-value">${comprou}</div>
                                <div class="metric-label">Comprou</div>
                            </div>
                            <div class="metric" style="background: #dc2626;">
                                <div class="metric-value">${naoComprou}</div>
                                <div class="metric-label">N√£o Comprou</div>
                            </div>
                            <div class="metric" style="background: #ea580c;">
                                <div class="metric-value">${noShow}</div>
                                <div class="metric-label">No Show</div>
                            </div>
                            <div class="metric" style="background: #6b7280;">
                                <div class="metric-value">${semStatus}</div>
                                <div class="metric-label">Sem Status</div>
                            </div>
                        </div>
                        <p style="margin-top: 20px; font-size: 18px;">
                            <strong>Total de calls em Outubro:</strong> ${vendasOutubro.length}
                        </p>
                    </div>

                    <div class="card">
                        <h2>üîç Valores √önicos encontrados</h2>
                        <p><strong>COMPROU:</strong> ${JSON.stringify(valoresUnicos.comprou)}</p>
                        <p><strong>N√ÉO COMPROU:</strong> ${JSON.stringify(valoresUnicos.naoComprou)}</p>
                        <p><strong>NO SHOW:</strong> ${JSON.stringify(valoresUnicos.noShow)}</p>
                    </div>
                `;

                // Mostrar problemas
                if (problemas.length > 0) {
                    html += `
                        <div class="card">
                            <h2>‚ö†Ô∏è Registros com Problemas (${problemas.length})</h2>
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Tipo</th>
                                        <th>Data</th>
                                        <th>COMPROU</th>
                                        <th>N√ÉO COMPROU</th>
                                        <th>NO SHOW</th>
                                        <th>Funil</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    problemas.slice(0, 20).forEach(p => {
                        html += `
                            <tr>
                                <td>${p.index}</td>
                                <td><span class="status neutral">${p.tipo}</span></td>
                                <td>${p.registro.DATA || '-'}</td>
                                <td>${p.registro.COMPROU || 'null'}</td>
                                <td>${p.registro['N√ÉO COMPROU'] || 'null'}</td>
                                <td>${p.registro['NO SHOW'] || 'null'}</td>
                                <td>${p.registro.FUNIL || '-'}</td>
                            </tr>
                        `;
                    });

                    html += `
                                </tbody>
                            </table>
                            ${problemas.length > 20 ? `<p style="margin-top: 10px; color: #f59e0b;">Mostrando apenas os primeiros 20 de ${problemas.length} registros</p>` : ''}
                        </div>
                    `;
                }

                // Mostrar alguns exemplos de cada categoria
                html += `
                    <div class="card">
                        <h2>üìã Exemplos de Registros</h2>
                        <h3 style="color: #22c55e;">‚úì Comprou (${comprou})</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>COMPROU</th>
                                    <th>N√ÉO COMPROU</th>
                                    <th>NO SHOW</th>
                                    <th>Funil</th>
                                    <th>Closer</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                vendasOutubro.filter(v => v.COMPROU === '1').slice(0, 5).forEach(v => {
                    html += `
                        <tr>
                            <td>${v.DATA || '-'}</td>
                            <td><span class="status comprou">${v.COMPROU}</span></td>
                            <td>${v['N√ÉO COMPROU'] || 'null'}</td>
                            <td>${v['NO SHOW'] || 'null'}</td>
                            <td>${v.FUNIL || '-'}</td>
                            <td>${v['QUEM FEZ A CALL'] || '-'}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>

                        <h3 style="color: #ef4444; margin-top: 20px;">‚úó N√£o Comprou (${naoComprou})</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>COMPROU</th>
                                    <th>N√ÉO COMPROU</th>
                                    <th>NO SHOW</th>
                                    <th>Funil</th>
                                    <th>Closer</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                const naoComprouExemplos = vendasOutubro.filter(v => v['N√ÉO COMPROU'] === '1').slice(0, 5);
                if (naoComprouExemplos.length === 0) {
                    html += '<tr><td colspan="6" style="text-align: center; color: #f59e0b;">‚ö†Ô∏è NENHUM REGISTRO ENCONTRADO</td></tr>';
                } else {
                    naoComprouExemplos.forEach(v => {
                        html += `
                            <tr>
                                <td>${v.DATA || '-'}</td>
                                <td>${v.COMPROU || 'null'}</td>
                                <td><span class="status nao-comprou">${v['N√ÉO COMPROU']}</span></td>
                                <td>${v['NO SHOW'] || 'null'}</td>
                                <td>${v.FUNIL || '-'}</td>
                                <td>${v['QUEM FEZ A CALL'] || '-'}</td>
                            </tr>
                        `;
                    });
                }

                html += `
                            </tbody>
                        </table>

                        <h3 style="color: #f59e0b; margin-top: 20px;">‚óØ No Show (${noShow})</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>COMPROU</th>
                                    <th>N√ÉO COMPROU</th>
                                    <th>NO SHOW</th>
                                    <th>Funil</th>
                                    <th>Closer</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                const noShowExemplos = vendasOutubro.filter(v => v['NO SHOW'] === '1').slice(0, 5);
                if (noShowExemplos.length === 0) {
                    html += '<tr><td colspan="6" style="text-align: center; color: #f59e0b;">‚ö†Ô∏è NENHUM REGISTRO ENCONTRADO</td></tr>';
                } else {
                    noShowExemplos.forEach(v => {
                        html += `
                            <tr>
                                <td>${v.DATA || '-'}</td>
                                <td>${v.COMPROU || 'null'}</td>
                                <td>${v['N√ÉO COMPROU'] || 'null'}</td>
                                <td><span class="status no-show">${v['NO SHOW']}</span></td>
                                <td>${v.FUNIL || '-'}</td>
                                <td>${v['QUEM FEZ A CALL'] || '-'}</td>
                            </tr>
                        `;
                    });
                }

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                // Diagn√≥stico
                if (naoComprou === 0 && noShow === 0) {
                    html += `
                        <div class="warning">
                            <h2 style="margin-top: 0; color: #92400e;">üö® PROBLEMA IDENTIFICADO!</h2>
                            <p><strong>Todos os ${vendasOutubro.length} registros de Outubro est√£o marcados como "COMPROU = 1" ou sem status definido.</strong></p>
                            <p>Isso n√£o √© normal. Poss√≠veis causas:</p>
                            <ul>
                                <li>Os dados foram importados incorretamente</li>
                                <li>Houve um erro no N8N ao processar os dados</li>
                                <li>Os campos "N√ÉO COMPROU" e "NO SHOW" n√£o est√£o sendo preenchidos</li>
                            </ul>
                            <p><strong>Solu√ß√£o:</strong> Verificar a fonte de dados (planilha/N8N) e reprocessar os dados de Outubro.</p>
                        </div>
                    `;
                }

                resultados.innerHTML = html;

            } catch (error) {
                console.error('‚ùå Erro:', error);
                resultados.innerHTML = `<div class="card" style="background: #7f1d1d; color: #fef2f2;"><h2>‚ùå Erro</h2><p>${error.message}</p></div>`;
            }
        }

        async function compararMeses() {
            const resultados = document.getElementById('resultados');
            resultados.innerHTML = '<p>Carregando dados...</p>';

            try {
                const { data: vendas, error } = await supabase
                    .from('Total de Vendas')
                    .select('*');

                if (error) throw error;

                // Agrupar por m√™s
                const porMes = {};
                
                vendas.forEach(v => {
                    const mes = v.M√äS || 'Sem m√™s';
                    if (!porMes[mes]) {
                        porMes[mes] = {
                            total: 0,
                            comprou: 0,
                            naoComprou: 0,
                            noShow: 0
                        };
                    }

                    porMes[mes].total++;
                    if (v.COMPROU === '1') porMes[mes].comprou++;
                    if (v['N√ÉO COMPROU'] === '1') porMes[mes].naoComprou++;
                    if (v['NO SHOW'] === '1') porMes[mes].noShow++;
                });

                let html = `
                    <div class="card">
                        <h2>üìä Compara√ß√£o entre Meses</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>M√™s</th>
                                    <th>Total Calls</th>
                                    <th>Comprou</th>
                                    <th>N√£o Comprou</th>
                                    <th>No Show</th>
                                    <th>% Convers√£o</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                Object.entries(porMes).forEach(([mes, dados]) => {
                    const conversao = dados.comprou + dados.naoComprou > 0
                        ? ((dados.comprou / (dados.comprou + dados.naoComprou)) * 100).toFixed(1)
                        : 0;
                    
                    const problema = dados.naoComprou === 0 && dados.noShow === 0;
                    const rowStyle = problema ? 'background: #7f1d1d;' : '';

                    html += `
                        <tr style="${rowStyle}">
                            <td><strong>${mes}</strong></td>
                            <td>${dados.total}</td>
                            <td><span class="status comprou">${dados.comprou}</span></td>
                            <td><span class="status nao-comprou">${dados.naoComprou}</span></td>
                            <td><span class="status no-show">${dados.noShow}</span></td>
                            <td>${conversao}%</td>
                            <td>${problema ? '‚ö†Ô∏è PROBLEMA' : '‚úì OK'}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                resultados.innerHTML = html;

            } catch (error) {
                console.error('‚ùå Erro:', error);
                resultados.innerHTML = `<div class="card" style="background: #7f1d1d; color: #fef2f2;"><h2>‚ùå Erro</h2><p>${error.message}</p></div>`;
            }
        }

        // Analisar automaticamente ao carregar
        window.onload = () => {
            analisarOutubro();
        };
    </script>
</body>
</html>

