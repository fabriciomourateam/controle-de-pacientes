<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Shape - Construindo Resultados</title>
  <meta name="description"
    content="Sistema completo de gestão para nutricionistas. Controle de pacientes, check-ins, métricas e muito mais." />
  <meta name="author" content="My Shape" />
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/Logo.png" />
  <link rel="shortcut icon" type="image/png" href="/Logo.png" />
  <link rel="apple-touch-icon" href="/Logo.png" />

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="My Shape" />
  <meta name="msapplication-TileColor" content="#0f172a" />
  <meta name="msapplication-tap-highlight" content="no" />

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json" />

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="/Logo.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="/Logo.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/Logo.png" />
  <link rel="apple-touch-icon" sizes="167x167" href="/Logo.png" />

  <meta property="og:title" content="My Shape - Construindo Resultados" />
  <meta property="og:description"
    content="Preencha sua anamnese ou check-in de forma rápida e segura. My Shape — acompanhamento nutricional personalizado." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://my-shape.vercel.app/og-myshape.png" />
  <meta property="og:url" content="https://my-shape.vercel.app" />
  <meta property="og:site_name" content="My Shape" />
  <meta property="og:locale" content="pt_BR" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="My Shape - Construindo Resultados" />
  <meta name="twitter:description" content="Acompanhamento nutricional personalizado." />
  <meta name="twitter:image" content="https://my-shape.vercel.app/og-myshape.png" />
</head>

<body>
  <div id="root"></div>
  <script>
    // Polyfills e proteções para evitar erros de prototype
    (function () {
      'use strict';

      // Polyfill para global (necessário para Supabase no navegador)
      if (typeof global === 'undefined') {
        var global = globalThis;
      }

      // Garantir que window está disponível
      if (typeof window !== 'undefined') {
        window.global = window.global || globalThis;
      }

      // Prevenir erros de prototype - garantir que Object.setPrototypeOf existe
      if (typeof Object.setPrototypeOf === 'undefined') {
        Object.setPrototypeOf = function (obj, proto) {
          if (obj === null || obj === undefined) {
            throw new TypeError('Object.setPrototypeOf called on null or undefined');
          }
          if (typeof obj !== 'object' && typeof obj !== 'function') {
            throw new TypeError('Object.setPrototypeOf called on non-object');
          }
          obj.__proto__ = proto;
          return obj;
        };
      }

      // Proteção adicional: garantir que Object.getPrototypeOf existe
      if (typeof Object.getPrototypeOf === 'undefined') {
        Object.getPrototypeOf = function (obj) {
          if (obj === null || obj === undefined) {
            throw new TypeError('Object.getPrototypeOf called on null or undefined');
          }
          return obj.__proto__ || Object.prototype;
        };
      }

      // Proteção para Array.prototype
      if (typeof Array === 'undefined' || !Array.prototype) {
        console.error('Array is not available');
      }

      // Proteção para Function.prototype
      if (typeof Function === 'undefined' || !Function.prototype) {
        console.error('Function is not available');
      }

      // Proteção para Object.prototype
      if (typeof Object === 'undefined' || !Object.prototype) {
        console.error('Object is not available');
      }

      // Garantir que Promise está disponível
      if (typeof Promise === 'undefined') {
        console.error('Promise is not available - this may cause issues');
      }

      // Proteção para acessos a prototype de objetos undefined
      const originalGetPrototypeOf = Object.getPrototypeOf;
      Object.getPrototypeOf = function (obj) {
        if (obj === null || obj === undefined) {
          throw new TypeError('Cannot read properties of null or undefined (reading \'prototype\')');
        }
        return originalGetPrototypeOf.call(this, obj);
      };
    })();
  </script>
  <script type="module" src="/src/main.tsx"></script>

  <!-- PWA Service Worker - Registrar após o app carregar -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        // NÃO registrar PWA/SW em rotas públicas (anamnese e checkin)
        // Pacientes não devem ver prompt de instalar app
        const publicPaths = ['/anamnese/', '/checkin/'];
        const isPublicRoute = publicPaths.some(p => window.location.pathname.startsWith(p));

        if (isPublicRoute) {
          // Em rotas públicas: desregistrar SW e remover manifest para não mostrar install prompt
          try {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (let registration of registrations) {
              await registration.unregister();
            }
          } catch (e) { /* silencioso */ }

          // Remover manifest link para impedir install banner
          const manifestLink = document.querySelector('link[rel="manifest"]');
          if (manifestLink) manifestLink.remove();

          console.log('[PWA] Rota pública — PWA desabilitado');
          return;
        }

        // Rotas admin: registrar SW normalmente
        await new Promise(resolve => setTimeout(resolve, 1000));

        try {
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (let registration of registrations) {
            await registration.unregister();
          }

          if ('caches' in window) {
            const cacheNames = await caches.keys();
            await Promise.all(cacheNames.map(cacheName => caches.delete(cacheName)));
          }

          await new Promise(resolve => setTimeout(resolve, 500));

          const registration = await navigator.serviceWorker.register('/sw.js', {
            updateViaCache: 'none',
            scope: '/'
          });

          console.log('SW registrado com sucesso:', registration);

          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            if (newWorker) {
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  console.log('Novo Service Worker disponível, recarregando...');
                  window.location.reload();
                }
              });
            }
          });

          setInterval(() => {
            registration.update();
          }, 5 * 60 * 1000);

        } catch (error) {
          console.error('Erro ao gerenciar Service Worker:', error);
        }
      });
    }
  </script>
</body>

</html>