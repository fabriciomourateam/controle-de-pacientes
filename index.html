<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Shape - Construindo Resultados</title>
  <meta name="description"
    content="Sistema completo de gestão para nutricionistas. Controle de pacientes, check-ins, métricas e muito mais." />
  <meta name="author" content="My Shape" />
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-grow.png" />
  <link rel="shortcut icon" type="image/png" href="/favicon-grow.png" />
  <link rel="apple-touch-icon" href="/favicon-grow.png" />

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="My Shape" />
  <meta name="msapplication-TileColor" content="#0f172a" />
  <meta name="msapplication-tap-highlight" content="no" />

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json" />

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="/favicon-grow.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="/favicon-grow.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon-grow.png" />
  <link rel="apple-touch-icon" sizes="167x167" href="/favicon-grow.png" />

  <meta property="og:title" content="My Shape - Controle da sua Empresa" />
  <meta property="og:description"
    content="Sistema completo de gestão para nutricionistas. Transforme seu consultório com My Shape." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@lovable_dev" />
  <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
</head>

<body>
  <div id="root"></div>
  <script>
    // Polyfills e proteções para evitar erros de prototype
    (function () {
      'use strict';

      // Polyfill para global (necessário para Supabase no navegador)
      if (typeof global === 'undefined') {
        var global = globalThis;
      }

      // Garantir que window está disponível
      if (typeof window !== 'undefined') {
        window.global = window.global || globalThis;
      }

      // Prevenir erros de prototype - garantir que Object.setPrototypeOf existe
      if (typeof Object.setPrototypeOf === 'undefined') {
        Object.setPrototypeOf = function (obj, proto) {
          if (obj === null || obj === undefined) {
            throw new TypeError('Object.setPrototypeOf called on null or undefined');
          }
          if (typeof obj !== 'object' && typeof obj !== 'function') {
            throw new TypeError('Object.setPrototypeOf called on non-object');
          }
          obj.__proto__ = proto;
          return obj;
        };
      }

      // Proteção adicional: garantir que Object.getPrototypeOf existe
      if (typeof Object.getPrototypeOf === 'undefined') {
        Object.getPrototypeOf = function (obj) {
          if (obj === null || obj === undefined) {
            throw new TypeError('Object.getPrototypeOf called on null or undefined');
          }
          return obj.__proto__ || Object.prototype;
        };
      }

      // Proteção para Array.prototype
      if (typeof Array === 'undefined' || !Array.prototype) {
        console.error('Array is not available');
      }

      // Proteção para Function.prototype
      if (typeof Function === 'undefined' || !Function.prototype) {
        console.error('Function is not available');
      }

      // Proteção para Object.prototype
      if (typeof Object === 'undefined' || !Object.prototype) {
        console.error('Object is not available');
      }

      // Garantir que Promise está disponível
      if (typeof Promise === 'undefined') {
        console.error('Promise is not available - this may cause issues');
      }

      // Proteção para acessos a prototype de objetos undefined
      const originalGetPrototypeOf = Object.getPrototypeOf;
      Object.getPrototypeOf = function (obj) {
        if (obj === null || obj === undefined) {
          throw new TypeError('Cannot read properties of null or undefined (reading \'prototype\')');
        }
        return originalGetPrototypeOf.call(this, obj);
      };
    })();
  </script>
  <script type="module" src="/src/main.tsx"></script>

  <!-- PWA Service Worker - Registrar após o app carregar -->
  <script>
    if ('serviceWorker' in navigator) {
      // Aguardar o app carregar completamente antes de registrar SW
      window.addEventListener('load', async () => {
        // Aguardar um pouco mais para garantir que tudo carregou
        await new Promise(resolve => setTimeout(resolve, 1000));

        try {
          // Desregistrar todos os service workers antigos primeiro
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (let registration of registrations) {
            await registration.unregister();
            console.log('Service Worker antigo desregistrado');
          }

          // Limpar todos os caches
          if ('caches' in window) {
            const cacheNames = await caches.keys();
            await Promise.all(
              cacheNames.map(cacheName => caches.delete(cacheName))
            );
            console.log('Caches limpos');
          }

          // Aguardar um pouco antes de registrar o novo
          await new Promise(resolve => setTimeout(resolve, 500));

          // Registrar o novo service worker
          const registration = await navigator.serviceWorker.register('/sw.js', {
            updateViaCache: 'none', // Sempre buscar atualizações
            scope: '/' // Escopo explícito
          });

          console.log('SW registrado com sucesso:', registration);

          // Verificar atualizações periodicamente
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            if (newWorker) {
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // Novo service worker disponível, recarregar página
                  console.log('Novo Service Worker disponível, recarregando...');
                  window.location.reload();
                }
              });
            }
          });

          // Verificar atualizações a cada 5 minutos
          setInterval(() => {
            registration.update();
          }, 5 * 60 * 1000);

        } catch (error) {
          console.error('Erro ao gerenciar Service Worker:', error);
        }
      });
    }
  </script>
</body>

</html>